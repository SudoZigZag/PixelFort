<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PixelFort - Photo NAS</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Header */
        header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h1 {
            color: #667eea;
            font-size: 28px;
        }

        .user-info {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .btn:hover {
            background: #5568d3;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        /* Auth Forms */
        .auth-container {
            max-width: 400px;
            margin: 100px auto;
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #333;
            font-weight: 500;
        }

        input[type="text"],
        input[type="email"],
        input[type="password"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        input:focus {
            outline: none;
            border-color: #667eea;
        }

        .error {
            background: #fee;
            color: #c33;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .success {
            background: #efe;
            color: #3c3;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .link {
            color: #667eea;
            cursor: pointer;
            text-decoration: underline;
        }

        /* Upload Area */
        .upload-area {
            background: white;
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .upload-area:hover {
            background: #f8f9ff;
            border-color: #5568d3;
        }

        .upload-area.dragging {
            background: #f0f2ff;
            border-color: #4c5fd4;
        }

        /* Photo Grid */
        .photo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .photo-card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .photo-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }

        .photo-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .photo-info {
            padding: 15px;
        }

        .photo-filename {
            font-weight: 500;
            color: #333;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .photo-meta {
            font-size: 12px;
            color: #666;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            padding: 20px;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 10px;
            max-width: 1000px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #f44336;
            color: white;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            z-index: 10;
        }

        .modal-image {
            width: 100%;
            border-radius: 10px 10px 0 0;
        }

        .modal-details {
            padding: 20px;
        }

        .exif-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .exif-item {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
        }

        .exif-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .exif-value {
            font-weight: 500;
            color: #333;
        }

        .hidden {
            display: none;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 18px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: white;
            border-radius: 10px;
            color: #666;
        }

        .empty-state h2 {
            color: #667eea;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <!-- Auth Container (Login/Register) -->
    <div id="authContainer" class="auth-container">
        <h1 style="text-align: center; margin-bottom: 30px;">üì∏ PixelFort</h1>
        
        <!-- Login Form -->
        <div id="loginForm">
            <h2 style="margin-bottom: 20px;">Login</h2>
            <div id="loginError" class="error hidden"></div>
            
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="loginEmail" placeholder="your@email.com">
            </div>
            
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="loginPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            
            <button class="btn" style="width: 100%; margin-bottom: 15px;" onclick="login()">
                Login
            </button>
            
            <p style="text-align: center; color: #666;">
                Don't have an account? 
                <span class="link" onclick="showRegister()">Register</span>
            </p>
        </div>

        <!-- Register Form -->
        <div id="registerForm" class="hidden">
            <h2 style="margin-bottom: 20px;">Register</h2>
            <div id="registerError" class="error hidden"></div>
            
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="registerEmail" placeholder="your@email.com">
            </div>
            
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="registerUsername" placeholder="username">
            </div>
            
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="registerPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
            </div>
            
            <button class="btn" style="width: 100%; margin-bottom: 15px;" onclick="register()">
                Register
            </button>
            
            <p style="text-align: center; color: #666;">
                Already have an account? 
                <span class="link" onclick="showLogin()">Login</span>
            </p>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="appContainer" class="container hidden">
        <header>
            <h1>üì∏ PixelFort</h1>
            <div class="user-info">
                <span id="username">User</span>
                <button class="btn btn-secondary" onclick="logout()">Logout</button>
            </div>
        </header>

        <!-- Upload Area -->
        <div class="upload-area" id="uploadArea">
            <h2 style="color: #667eea; margin-bottom: 10px;">üì§ Upload Photos</h2>
            <p style="color: #666;">Click to select or drag & drop photos here</p>
            <input type="file" id="fileInput" accept="image/*" multiple style="display: none;">
        </div>

        <!-- Photos Grid -->
        <div id="photosContainer">
            <div class="loading">Loading photos...</div>
        </div>
    </div>

    <!-- Photo Modal -->
    <div id="photoModal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeModal()">√ó</button>
            <img id="modalImage" class="modal-image" src="" alt="">
            <div class="modal-details">
                <h2 id="modalFilename"></h2>
                <div class="exif-info" id="exifInfo"></div>
                <button class="btn" style="margin-top: 20px;" onclick="downloadPhoto()">
                    ‚¨áÔ∏è Download Original
                </button>
                <button class="btn" style="margin-top: 20px; margin-left: 10px; background: #f44336;" onclick="deletePhoto()">
                    üóëÔ∏è Delete
                </button>
            </div>
        </div>
    </div>

    <script>
        // State
        let token = localStorage.getItem('token');
        let currentUser = null;
        let currentPhoto = null;
        const API_BASE = window.location.origin;

        // Initialize
        if (token) {
            loadUser();
        } else {
            showAuth();
        }

        // Auth Functions
        function showAuth() {
            document.getElementById('authContainer').classList.remove('hidden');
            document.getElementById('appContainer').classList.add('hidden');
        }

        function showApp() {
            document.getElementById('authContainer').classList.add('hidden');
            document.getElementById('appContainer').classList.remove('hidden');
            loadPhotos();
        }

        function showLogin() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
        }

        function showRegister() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
        }

        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorEl = document.getElementById('loginError');

            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (response.ok) {
                    token = data.access_token;
                    localStorage.setItem('token', token);
                    currentUser = data.user;
                    showApp();
                } else {
                    errorEl.textContent = data.detail || 'Login failed';
                    errorEl.classList.remove('hidden');
                }
            } catch (error) {
                errorEl.textContent = 'Network error';
                errorEl.classList.remove('hidden');
            }
        }

        async function register() {
            const email = document.getElementById('registerEmail').value;
            const username = document.getElementById('registerUsername').value;
            const password = document.getElementById('registerPassword').value;
            const errorEl = document.getElementById('registerError');

            try {
                const response = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, username, password })
                });

                const data = await response.json();

                if (response.ok) {
                    token = data.access_token;
                    localStorage.setItem('token', token);
                    currentUser = data.user;
                    showApp();
                } else {
                    errorEl.textContent = data.detail || 'Registration failed';
                    errorEl.classList.remove('hidden');
                }
            } catch (error) {
                errorEl.textContent = 'Network error';
                errorEl.classList.remove('hidden');
            }
        }

        async function loadUser() {
            try {
                const response = await fetch(`${API_BASE}/auth/me`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    currentUser = await response.json();
                    document.getElementById('username').textContent = currentUser.username;
                    showApp();
                } else {
                    logout();
                }
            } catch (error) {
                logout();
            }
        }

        function logout() {
            token = null;
            currentUser = null;
            localStorage.removeItem('token');
            showAuth();
        }

        // Photo Functions
        async function loadPhotos() {
            const container = document.getElementById('photosContainer');
            
            try {
                const response = await fetch(`${API_BASE}/photos`);
                const data = await response.json();
                
                // Handle both list and object response formats
                const photos = Array.isArray(data) ? data : data.users || [];

                if (photos.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <h2>No photos yet</h2>
                            <p>Upload your first photo to get started!</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = `
                    <div class="photo-grid">
                        ${photos.map(photo => `
                            <div class="photo-card" onclick="viewPhoto(${photo.id})">
                                <img src="${API_BASE}/photos/${photo.id}/thumbnail" 
                                     alt="${photo.original_filename}"
                                     onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22200%22><rect fill=%22%23ddd%22 width=%22200%22 height=%22200%22/><text x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 fill=%22%23999%22>No Image</text></svg>'">
                                <div class="photo-info">
                                    <div class="photo-filename">${photo.original_filename}</div>
                                    <div class="photo-meta">
                                        ${photo.camera_model || 'No camera info'}
                                        ${photo.date_taken ? '‚Ä¢ ' + new Date(photo.date_taken).toLocaleDateString() : ''}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                container.innerHTML = `
                    <div class="error">Failed to load photos</div>
                `;
            }
        }

        async function viewPhoto(id) {
            try {
                const response = await fetch(`${API_BASE}/photos/${id}`);
                currentPhoto = await response.json();

                document.getElementById('modalImage').src = `${API_BASE}/photos/${id}/view`;
                document.getElementById('modalFilename').textContent = currentPhoto.original_filename;

                // Build EXIF info
                const exifHtml = `
                    ${currentPhoto.camera_make ? `
                        <div class="exif-item">
                            <div class="exif-label">Camera</div>
                            <div class="exif-value">${currentPhoto.camera_make} ${currentPhoto.camera_model || ''}</div>
                        </div>
                    ` : ''}
                    ${currentPhoto.date_taken ? `
                        <div class="exif-item">
                            <div class="exif-label">Date Taken</div>
                            <div class="exif-value">${new Date(currentPhoto.date_taken).toLocaleString()}</div>
                        </div>
                    ` : ''}
                    ${currentPhoto.width ? `
                        <div class="exif-item">
                            <div class="exif-label">Dimensions</div>
                            <div class="exif-value">${currentPhoto.width} √ó ${currentPhoto.height}</div>
                        </div>
                    ` : ''}
                    ${currentPhoto.file_size ? `
                        <div class="exif-item">
                            <div class="exif-label">File Size</div>
                            <div class="exif-value">${(currentPhoto.file_size / 1024 / 1024).toFixed(2)} MB</div>
                        </div>
                    ` : ''}
                    ${currentPhoto.gps_latitude ? `
                        <div class="exif-item">
                            <div class="exif-label">Location</div>
                            <div class="exif-value">${currentPhoto.gps_latitude.toFixed(4)}, ${currentPhoto.gps_longitude.toFixed(4)}</div>
                        </div>
                    ` : ''}
                `;

                document.getElementById('exifInfo').innerHTML = exifHtml || '<p style="color: #999;">No EXIF data available</p>';
                document.getElementById('photoModal').classList.add('active');
            } catch (error) {
                alert('Failed to load photo details');
            }
        }

        function closeModal() {
            document.getElementById('photoModal').classList.remove('active');
            currentPhoto = null;
        }

        function downloadPhoto() {
            if (currentPhoto) {
                window.open(`${API_BASE}/photos/${currentPhoto.id}/download`, '_blank');
            }
        }

        async function deletePhoto() {
            if (!currentPhoto || !confirm('Are you sure you want to delete this photo?')) {
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/photos/${currentPhoto.id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    closeModal();
                    loadPhotos();
                } else {
                    const data = await response.json();
                    alert(data.detail || 'Failed to delete photo');
                }
            } catch (error) {
                alert('Network error');
            }
        }

        // Upload Functions
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');

        uploadArea.addEventListener('click', () => fileInput.click());

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragging');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragging');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragging');
            handleFiles(e.dataTransfer.files);
        });

        async function handleFiles(files) {
            for (const file of files) {
                if (!file.type.startsWith('image/')) {
                    alert(`${file.name} is not an image`);
                    continue;
                }

                await uploadPhoto(file);
            }

            fileInput.value = '';
            loadPhotos();
        }

        async function uploadPhoto(file) {
            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch(`${API_BASE}/photos/upload`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });

                if (!response.ok) {
                    const data = await response.json();
                    alert(`Failed to upload ${file.name}: ${data.detail}`);
                }
            } catch (error) {
                alert(`Network error uploading ${file.name}`);
            }
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
            }
        });
    </script>
</body>
</html>